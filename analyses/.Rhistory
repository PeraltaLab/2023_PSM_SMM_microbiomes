p1 <- shannon_PSM
p2 <- evenness_PSM
p3 <- bact_PSM_avg
p4 <- bact_PSM_indiv
# Hide legends for plots you don’t want
p1 <- p1 + theme(legend.position = "none")
p2 <- p2 + theme(legend.position = "none")
p3 <- p3 + theme(legend.position = "bottom")
p4 <- p4 + theme(legend.position = "none")
# Combine 2x2 layout
combined <- (p1 | p2) / (p3 | p4) +
plot_annotation(tag_levels = "A")  # optional subplot labels
ggsave("../figures/combined_bacteria.png", plot=last_plot(), device=NULL, path=NULL, scale=1, width=12, height=12, dpi=900, limitsize=TRUE)
#use to set global options for chunks e.g., echo and warning options will be applied to all chunks:
knitr::opts_chunk$set(echo = TRUE)
# Clear environment:
rm(list=ls())
# Set working directory:
setwd("~/GitHub/2023_PSM_SMM_microbiomes/analyses")
# Standard error (se) and confidence interval (ci):
se <- function(x, ...){sd(x, na.rm = TRUE)/sqrt(length(na.omit(x)))}
ci <- function(x, ...){1.96 * sd(x,na.rm = TRUE)}
# Code dependencies:
source("../bin/DiversityFunctions.R")
source("../bin/MothurTools.R")
require("vegan"); require("reshape"); require("ggplot2"): require("tidyr"); require("dplyr"); require("dbstats"); require("reshape2"); require("ggpubr"); require("glue"); require("tidyverse"); require("labdsv"); require("phyloseq")
file_path <- ("../data/PSM_SMM_design.csv")
design <- read.csv(file_path, row.names=1)
file_path <- ("../data/PSM_SMM_design.csv")
file_path <- ("../data/PSM_SMM_design.csv")
design <- read.csv(file_path, row.names=1)
design <- read.csv(file_path, row.names=1)
# Set working directory:
setwd("~/GitHub/2023_PSM_SMM_microbiomes/analyses")
file_path <- ("../data/PSM_SMM_design.csv")
design <- read.csv(file_path, row.names=1)
file_path <- ("../data/PSM_SMM_design.csv")
design <- read.csv(file_path, row.names=1)
dim(design) #117  11
str(design)
#Convert chr to factors
design$Study <- as.factor(design$Study)
design$Microbe_TRT <- as.factor(design$Microbe_TRT)
design$Water_TRT <- as.factor(design$Water_TRT)
design$Date2 <- as.factor(design$Date2)
design$TRT_row <- as.factor(design$TRT_row)
design$Source <- as.factor(design$Source) # coded as categorical for bulk vs rhiz
str(design)
#READ IN OTU FILE
otu_file <-("../data/PSM_SMM.trim.contigs.good.unique.good.filter.unique.precluster.denovo.vsearch.pick.opti_mcc.shared")
otu <- read.otu(otu_file)
#READ IN TAXONOMY FILE
tax_file <- ("../data/PSM_SMM.trim.contigs.good.unique.good.filter.unique.precluster.denovo.vsearch.pick.opti_mcc.0.03.cons.taxonomy")
tax <- import_mothur(mothur_constaxonomy_file =  tax_file)
colnames(tax)=c("Domain","Phylum","Class", "Order","Family","Genus")
tax_df <- as.data.frame(tax)
otu.tax <- read.tax(taxonomy = "../data/PSM_SMM.trim.contigs.good.unique.good.filter.unique.precluster.denovo.vsearch.pick.opti_mcc.0.03.cons.taxonomy",
format = "rdp", tax.levels = 6, col.tax = 3)
tax_df <- as.data.frame(otu.tax)
dim(otu) #117 72051
# OTU table - remove otus w/ < 2 occurrences across all sites
otu.2 <- otu[, which(colSums(otu) > 2)]
dim(otu.2) #117 39166
# OTU table - remove otus w/ < 10 occurrences across all sites
otu.10 <- otu[, which(colSums(otu) > 10)]
dim(otu.10) #117 20499
# Correct Sample IDs and Subset File
#check number of seqs per sample
#otu_sample <- rowSums(otu.2)
otu_sample <- rowSums(otu.10)
otu_sample
sum <- cbind(design,otu_sample)
write.csv(sum,"../data/PSM_SMM_OTUsum.csv")
#otu_sample represents total reads for each baseline source, note, autoclaved_field soil = 31 reads
#SampleID	BarcodeID	Study	Microbe_TRT	Water_TRT	otu_sample
#PSM_64	515rcbc64	PSM	field_soil	BASELINE	39371
#PSM_65	515rcbc65	PSM	autoclaved_field_soil	BASELINE	31
#PSM_66	515rcbc66	PSM	Microbe_pos	BASELINE	33181
#PSM_67	515rcbc67	PSM	Microbe_neg	BASELINE	34320
#PSM_68	515rcbc68	PSM	CONTROL	BASELINE	26330
# OTU table - removed low abundance samples
otu_keep <- otu.10[which(rowSums(otu.10) >= 10000), ] #removed temporarily PSM_65 b/c it represents low reads from autoclaved field soil; SMM_08 failed PCR
dim(otu_keep) #removed three samples
# OTU table - odd sites in bacterial composition data and remove in design file and remove positive control and remove all baseline samples
odd.sites <- c("Mock_Pos","PSM_65", "SMM_08", "PSM_61", "PSM_62","PSM_63", "PSM_64", "PSM_66", "PSM_67", "PSM_68")
otu_final <- otu_keep[setdiff(rownames(otu_keep), odd.sites), ]
design_final <- design[setdiff(rownames(design), odd.sites), ]
all.equal(rownames(design_final), rownames(otu_final))
dim(design_final) #107  11
design_PSM <- subset(design_final, Study == "PSM")
dim(design_PSM) #54 11
design_SMM <- subset(design_final, Study == "SMM")
dim(design_SMM) #53 11
otu_PSM <- otu_final[c(1:54),]
dim(otu_PSM) #54 20499
all.equal(rownames(design_PSM), rownames(otu_PSM))
otu_SMM <- otu_final[c(55:107),]
dim(otu_SMM) #53 20499
all.equal(rownames(design_SMM), rownames(otu_SMM))
#now that PSM and SMM are separated, we will apply removing rare OTUs that might have been missed
otu_PSM.10 <- otu_PSM[, which(colSums(otu_PSM) > 10)]
dim(otu_PSM.10) # 54 8321
otu_SMM.10 <- otu_SMM[, which(colSums(otu_SMM) > 10)]
dim(otu_SMM.10) # 53 14854
#RELATIVE ABUNDANCE
otu_rel_PSM <- otu_PSM.10
for(i in 1:dim(otu_PSM.10)[1]){
otu_rel_PSM[i,] <- otu_PSM.10[i,]/sum(otu_PSM.10[i,])
}
otu_rel_SMM <- otu_SMM.10
for(i in 1:dim(otu_SMM.10)[1]){
otu_rel_SMM[i,] <- otu_SMM.10[i,]/sum(otu_SMM.10[i,])
}
min(rowSums(otu_PSM.10)) #10967
otus.r <- rrarefy(otu_PSM.10, 10967) #updated
# Fisher's Alpha
fisher <- fisher.alpha(otus.r)
# Species Richness
richness <- rowSums((otu_PSM.10 >= 1))
# Shannon Diversity
shannon <- diversity(otus.r, "shannon")
# Simpson's Evenness
simp.even <- apply(otus.r, 1, simp_even)
#Pielou’s evenness
J <- shannon/log(specnumber(otus.r[,-c(1:1)]))
diversity_PSM <- cbind(design_PSM,richness,shannon,simp.even,J)
#write.csv(diversity,"../data/2014to2020.diversity.bact.raw.csv")
#ANOVA for Shannon diversity - original
anova_result <- aov(shannon ~ Water_TRT * Microbe_TRT, data = diversity_PSM)
summary(anova_result)
#Run non-parametric Kruskal-Wallis for Shannon diversity - updated
group <- interaction(diversity_PSM$Water_TRT, diversity_PSM$Microbe_TRT)
summary(group)
kruskal.test(shannon ~ group, data = diversity_PSM)
#ANOVA for Pielou's evenness - original
anova_result <- aov(J ~ Water_TRT * Microbe_TRT, data = diversity_PSM)
summary(anova_result)
#Run non-parametric Kruskal-Wallis for evenness - updated
kruskal.test(J ~ group, data = diversity_PSM)
str(diversity_PSM)
dim(diversity_PSM) #54 15
str(diversity_PSM)
# Graphing Shannon diversity
micro.labs <- c("No Addition", "Autoclaved Inocula", "Added Inocula") #for facet labels
names(micro.labs) <- c("CONTROL", "Microbe_neg", "Microbe_pos")
p <- ggplot(diversity_PSM, aes(x=Water_TRT,y=shannon, color=Water_TRT)) +
geom_boxplot() +
geom_point(aes(color=Water_TRT), size=2, position = position_jitterdodge())+
scale_color_manual(name="Treatment",
values=c("#004AAD", "#FFBD59"))
p1=p+facet_wrap(~Microbe_TRT)+facet_grid(. ~Microbe_TRT, labeller = labeller(Microbe_TRT=micro.labs))
shannon_PSM<-p1 + theme_bw() +
theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line
=element_line(colour = "black")) +
theme(axis.title=element_text(vjust=1,size=14,face="bold"),
axis.text=element_text(size=14), axis.text.x = element_text(vjust=1,
size=14), panel.border = element_rect(colour = "black",linewidth=1)) +
theme(axis.ticks.length=unit(0.3,"cm")) + labs(x = "Treatment", y = "Shannon Diversity Index (H')") +
theme(strip.text.x = element_text(size=12, face="bold"), strip.text.y =
element_text(size=14, face="bold"), strip.background = element_rect(colour="black",
fill="white", linewidth=1)) + theme(axis.text.x = element_text(angle = , hjust = ))
shannon_PSM
ggsave("../figures/PSM.shannon.png", plot=last_plot(), device=NULL, path=NULL, scale=1, width=7, height=5, dpi=300, limitsize=TRUE)
# Graphing evenness
p <- ggplot(diversity_PSM, aes(x=Water_TRT,y=J, color=Water_TRT)) +
geom_boxplot() +
geom_point(aes(color=Water_TRT), size=2, position = position_jitterdodge())+
scale_color_manual(name="Treatment",
values=c("#004AAD", "#FFBD59"))
p1=p+facet_wrap(~Microbe_TRT)+facet_grid(. ~Microbe_TRT, labeller = labeller(Microbe_TRT=micro.labs))
evenness_PSM <- p1 + theme_bw() +
theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line
=element_line(colour = "black")) +
theme(axis.title=element_text(vjust=1,size=14,face="bold"),
axis.text=element_text(size=14), axis.text.x = element_text(size=14), panel.border = element_rect(colour = "black",size=1)) +
theme(axis.ticks.length=unit(0.3,"cm")) + labs(x = "Treatment", y = "Pielou's Evenness (J')") +
theme(strip.text.x = element_text(size=12, face="bold"), strip.text.y =
element_text(size=14, face="bold"), strip.background = element_rect(colour="black",
fill="white", linewidth=1)) + theme(axis.text.x = element_text(angle = , hjust = )) +
labs(color = "Treatment")
evenness_PSM
ggsave("../figures/PSM.evenness.png", plot=last_plot(), device=NULL, path=NULL, scale=1, width=7, height=5, dpi=300, limitsize=TRUE)
#adonis2 results → tests for centroid differences (community composition shifts).
#betadisper results → tests for variance differences (dispersion/homogeneity).
#PERMANOVA
otu_design_PSM <- cbind(diversity_PSM,otu_rel_PSM)
dim(otu_design_PSM) #54 8336
dim(diversity_PSM) #54 15
otu_design_PSM <- droplevels(otu_design_PSM)
str(otu_design_PSM)
#COMBINE for publication
# --- Run PERMANOVA (adonis2) ---
adonis_PSM <- adonis2(
otu_design_PSM[,-c(1:15)] ~ Water_TRT * Microbe_TRT,
method = "bray",
data = otu_design_PSM,
permutations = 1000,
by = "terms",
set.seed=42
)
adonis_df <- as.data.frame(adonis_PSM)
# Convert adonis2 object to data frame
adonis_df <- as.data.frame(adonis_PSM) %>%
rownames_to_column(var = "Factor")  # move rownames to a column
# Check column names to use correct ones
colnames(adonis_df)
# Usually you’ll see something like: "Df" "SumOfSqs" "R2" "F" "Pr(>F)"
# Rename columns safely using base R if dplyr rename fails
names(adonis_df)[names(adonis_df) == "F"] <- "F_value"
names(adonis_df)[names(adonis_df) == "R2"] <- "R2_value"
names(adonis_df)[names(adonis_df) == "Pr(>F)"] <- "p_value"
adonis_results <- adonis_df %>%
select(Factor, F_value, R2_value, p_value) %>%
mutate(Test = "adonis2")
adonis_results <- adonis_results %>%
filter(!Factor %in% c("Residual", "Total"))
# --- Run betadisper for each factor ---
dist_mat <- vegdist(otu_design_PSM[,-c(1:15)], method = "bray")
disp_water <- betadisper(dist_mat, otu_design_PSM$Water_TRT)
disp_microbe <- betadisper(dist_mat, otu_design_PSM$Microbe_TRT)
disp_interaction <- betadisper(dist_mat, interaction(otu_design_PSM$Water_TRT,
otu_design_PSM$Microbe_TRT))
res_water <- permutest(disp_water, permutations=999)
res_microbe <- permutest(disp_microbe, permutations=999)
res_interaction <- permutest(disp_interaction, permutations=999)
betadisp_results <- data.frame(
Factor = c("Water_TRT", "Microbe_TRT", "Water_TRT × Microbe_TRT"),
F_value = c(res_water$tab[1,4],
res_microbe$tab[1,4],
res_interaction$tab[1,4]),
R2_value = NA,  # not applicable for betadisper
p_value = c(res_water$tab[1,6],
res_microbe$tab[1,6],
res_interaction$tab[1,6]),
Test = "betadisper"
)
# --- Combine both into one table ---
combined_results <- bind_rows(adonis_results, betadisp_results)
combined_results
library(gt)
gt_tbl <- combined_results %>%
mutate(
F_value = round(F_value, 2),
R2_value = round(R2_value, 3),
p_value = signif(p_value, 3)
) %>%
gt() %>%
tab_header(
title = "adonis2 and betadisper results",
subtitle = "Community composition and dispersion tests"
) %>%
cols_label(
Factor = "Factor",
F_value = "F",
R2_value = "R²",
p_value = "p",
Test = "Test"
) %>%
fmt_missing(columns = everything(), missing_text = "–") %>%
tab_style(
style = cell_text(weight = "bold"),
locations = cells_column_labels(everything())
)
gtsave(gt_tbl, filename = "../figures/adonis_betadisper_results.png")
# Classical (Metric) Multidimensional Scaling; returns PCoA coordinates
# eig=TRUE returns eigenvalues; k = # of dimensions to calculate
PSM_BC <- vegdist(otu_design_PSM[-c(1:15)], method="bray") #deleted last three samples which are baseline soils
pcoa_PSM <- cmdscale(PSM_BC, k=2, eig=TRUE, add=TRUE) # changing k to 2 because we only want 2 dimensions anyway
# Now trying add = TRUE because of https://www.youtube.com/watch?v=G5Qckqq5Erw
explainvar1b_PSM <- round(pcoa_PSM$eig[1] / sum(pcoa_PSM$eig), 3) * 100
explainvar2b_PSM <- round(pcoa_PSM$eig[2] / sum(pcoa_PSM$eig), 3) * 100
sum.eigb <- sum(explainvar1b_PSM, explainvar2b_PSM)
explainvar1b_PSM # 21.9
explainvar2b_PSM # 11.7
otu_design_PSM <- otu_design_PSM[c(1:54),]
pcoa.groups <- paste(otu_design_PSM$Water_TRT, otu_design_PSM$Microbe_TRT,sep = "_")
pcoa.points <- data.frame(pcoa_PSM$points, group = pcoa.groups)
# Calculate Centroids (mean and SE)
pcoa.L.centroids <- melt(pcoa.points, id="group", measure.vars = c("X1", "X2"))
pcoa.centroids <- acast(pcoa.L.centroids, variable ~ group, mean)
pcoa.centroids.se <- acast(pcoa.L.centroids, variable ~ group, se)
pcoa.centroids.sd <- acast(pcoa.L.centroids, variable ~ group, sd)
# Combine
pcoa.cent.dataframe <- cbind(t(pcoa.centroids), t(pcoa.centroids.se))
colnames(pcoa.cent.dataframe) <- c("V1", "V2", "V1e", "V2e")
pcoa.cent.treats <- rownames(pcoa.cent.dataframe)
Microbe <- c("No Addition", "Autoclaved Inocula", "Added Inocula","No Addition", "Autoclaved Inocula", "Added Inocula")
Water <- c("FRESH","FRESH","FRESH","SALT","SALT","SALT")
pcoa.cent.dataframe.trts <- as.data.frame(pcoa.cent.dataframe)
pcoa.cent.dataframe.trts$Microbe <- as.factor(Microbe)
pcoa.cent.dataframe.trts$Water <- as.factor(Water)
view(pcoa.cent.dataframe.trts)
df1a <- pcoa.cent.dataframe.trts
#Plot
plot1a <- ggplot(df1a, aes(x=V1, y=V2, colour=Water, shape = Microbe)) + theme_bw()
bact_PSM_avg <- plot1a + theme(panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
axis.line = element_line(colour = "black")) +
theme(panel.background = element_blank()) +
geom_errorbarh(aes(xmax=V1+V1e, xmin=V1-V1e, height=0.01), colour="black") +
geom_errorbar(aes(ymax=V2+V2e, ymin=V2-V2e, width=0.01), colour="black") +
geom_point(aes(colour=Water), size=5, stroke = 1.25, show.legend = TRUE) +
scale_color_manual(name="Treatment",
values=c("#004AAD", "#FFBD59")) +
theme(axis.title = element_text(size=14),
axis.text = element_text(size=14),
axis.text.x = element_text(size=14),
panel.border = element_rect(colour = "black", linewidth = 1.25)) +
theme(axis.ticks.length = unit(0.3, "cm")) +
xlab("PCoA 1 (21.9%)") + ylab("PCoA 2 (11.7%)") +
labs(colour = "Water", shape = "Microbe") +
guides(colour = guide_legend(override.aes = list(pch=16, size = 4)),
shape = guide_legend(override.aes = list(size = 4))) +
ggtitle("Bacterial 16SrRNA Community Composition")
bact_PSM_avg
ggsave("../figures/PSM.bact.ordination.jpg", plot=last_plot(), device=NULL, path=NULL, scale=1, width=7, height=5, dpi=300, limitsize=TRUE)
#PSM_BC <- vegdist(otu_design_PSM[c(1:54),-c(1:15)], method="bray") #deleted last three samples which are baseline soils
##pcoa_PSM <- cmdscale(PSM_BC, k=2, eig=TRUE, add=TRUE) # changing k to 2 because we only want 2 dimensions anyway
# Now trying add = TRUE because of https://www.youtube.com/watch?v=G5Qckqq5Erw
#explainvar1b_PSM <- round(pcoa_PSM$eig[1] / sum(pcoa_PSM$eig), 3) * 100
#explainvar2b_PSM <- round(pcoa_PSM$eig[2] / sum(pcoa_PSM$eig), 3) * 100
#sum.eigb <- sum(explainvar1b_PSM, explainvar2b_PSM)
#explainvar1b_PSM # 21.9
#explainvar2b_PSM # 11.7
pcoa_PSM.groups <- paste(otu_design_PSM$Water_TRT, otu_design_PSM$Microbe_TRT, sep = "_")
pcoa_PSM.points <- data.frame(pcoa_PSM$points, group = pcoa_PSM.groups)
pcoa.PSM.cent.dataframe.trts <- as.data.frame(pcoa_PSM.points)
#"No Addition", "Autoclaved Inocula", "Added Inocula"
Microbe <- c("Added Inocula","Added Inocula","Added Inocula","Added Inocula","Added Inocula","Added Inocula","Added Inocula","Added Inocula","Added Inocula","Added Inocula","Added Inocula","Added Inocula","Added Inocula","Added Inocula","Added Inocula","Added Inocula","Added Inocula","Added Inocula", "Autoclaved Inocula","Autoclaved Inocula","Autoclaved Inocula","Autoclaved Inocula","Autoclaved Inocula","Autoclaved Inocula","Autoclaved Inocula","Autoclaved Inocula","Autoclaved Inocula","Autoclaved Inocula","Autoclaved Inocula","Autoclaved Inocula","Autoclaved Inocula","Autoclaved Inocula","Autoclaved Inocula","Autoclaved Inocula","Autoclaved Inocula","No Addition","No Addition","No Addition","No Addition","No Addition","No Addition","No Addition","No Addition","No Addition","No Addition","No Addition","No Addition","No Addition","No Addition","No Addition","No Addition","No Addition","No Addition","No Addition")
Water <- c("FRESH","FRESH","FRESH","FRESH","FRESH","FRESH","FRESH","FRESH","FRESH","SALT","SALT","SALT","SALT","SALT","SALT","SALT","SALT","SALT","FRESH","FRESH","FRESH","FRESH","FRESH","FRESH","FRESH","FRESH","FRESH","SALT","SALT","SALT","SALT","SALT","SALT","SALT","SALT","FRESH","FRESH","FRESH","FRESH","FRESH","FRESH","FRESH","FRESH","FRESH","FRESH","SALT","SALT","SALT","SALT","SALT","SALT","SALT","SALT","SALT")
pcoa_PSM_indiv <- cbind(pcoa.PSM.cent.dataframe.trts,Water, Microbe)
str(pcoa_PSM_indiv)
pcoa_PSM_indiv$Water <- as.factor(pcoa_PSM_indiv$Water)
pcoa_PSM_indiv$Microbe <- as.factor(pcoa_PSM_indiv$Microbe)
dim(pcoa_PSM_indiv)
df1a <- pcoa_PSM_indiv
str(df1a)
#Plot using ggplot2 - individual
bact_PSM_indiv<- ggplot(df1a, aes(x=X1, y=X2, shape=Microbe, colour=Water)) +
geom_point(aes(shape = Microbe, colour = Water), stroke = 4) +
#removes gridlines from plot
theme_bw() +
theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
axis.line = element_line(colour = "black")) +
theme(axis.title = element_text(size=14),# face="bold"),
axis.text.x = element_text(size=14, color="black"),  axis.text.y = element_text(size=14, color="black"),
panel.border = element_rect(colour = "black", linewidth=1.25)) +
scale_color_manual(name="Treatment",
values=c("#004AAD", "#FFBD59")) +
#Set plot title text size
theme(plot.title=element_text(size=14)) +
#Set legend text size
theme(legend.text=element_text(size=10, face="bold"), legend.title = element_text(size=10, face="bold"))+
#Sets size of tick marks on axis
theme(axis.ticks.length=unit(0.3,"cm")) +
#Sets labels for plot title, axis titles, and legend headings
xlab("PCoA 1 (21.9%)") + ylab("PCoA 2 (11.7%)") +
labs(shape = "Microbe") +
labs(colour="Water") +
guides(color = guide_legend(override.aes = list(size = 1)))
bact_PSM_indiv
ggsave("../figures/PSM.bact.indiv.ordination.jpg", plot=last_plot(), device=NULL, path=NULL, scale=1, width=7, height=5, dpi=300, limitsize=TRUE)
library(ggplot2)
library(patchwork)
# change labels
p1 <- shannon_PSM
p2 <- evenness_PSM
p3 <- bact_PSM_avg
p4 <- bact_PSM_indiv
# Hide legends for plots you don’t want
p1 <- p1 + theme(legend.position = "none")
p2 <- p2 + theme(legend.position = "none")
p3 <- p3 + theme(legend.position = "bottom")
p4 <- p4 + theme(legend.position = "none")
# Combine 2x2 layout
combined <- (p1 | p2) / (p3 | p4) +
plot_annotation(tag_levels = "A")  # optional subplot labels
ggsave("../figures/combined_bacteria.png", plot=last_plot(), device=NULL, path=NULL, scale=1, width=12, height=12, dpi=900, limitsize=TRUE)
bact_PSM_avg <- plot1a + theme(panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
axis.line = element_line(colour = "black")) +
theme(panel.background = element_blank()) +
geom_errorbarh(aes(xmax=V1+V1e, xmin=V1-V1e, height=0.01), colour="black") +
geom_errorbar(aes(ymax=V2+V2e, ymin=V2-V2e, width=0.01), colour="black") +
geom_point(aes(colour=Water), size=5, stroke = 1.25, show.legend = TRUE) +
scale_color_manual(name="Treatment",
values=c("#004AAD", "#FFBD59")) +
theme(axis.title = element_text(size=14),
axis.text = element_text(size=14),
axis.text.x = element_text(size=14),
panel.border = element_rect(colour = "black", linewidth = 1.25)) +
theme(axis.ticks.length = unit(0.3, "cm")) +
xlab("PCoA 1 (21.9%)") + ylab("PCoA 2 (11.7%)") +
labs(colour = "Water", shape = "Microbe") +
guides(colour = guide_legend(override.aes = list(pch=16, size = 4)),
shape = guide_legend(override.aes = list(size = 4))) +
ggtitle("Bacterial 16SrRNA Community Composition (centroid)")
# Classical (Metric) Multidimensional Scaling; returns PCoA coordinates
# eig=TRUE returns eigenvalues; k = # of dimensions to calculate
PSM_BC <- vegdist(otu_design_PSM[-c(1:15)], method="bray") #deleted last three samples which are baseline soils
pcoa_PSM <- cmdscale(PSM_BC, k=2, eig=TRUE, add=TRUE) # changing k to 2 because we only want 2 dimensions anyway
# Now trying add = TRUE because of https://www.youtube.com/watch?v=G5Qckqq5Erw
explainvar1b_PSM <- round(pcoa_PSM$eig[1] / sum(pcoa_PSM$eig), 3) * 100
explainvar2b_PSM <- round(pcoa_PSM$eig[2] / sum(pcoa_PSM$eig), 3) * 100
sum.eigb <- sum(explainvar1b_PSM, explainvar2b_PSM)
explainvar1b_PSM # 21.9
explainvar2b_PSM # 11.7
otu_design_PSM <- otu_design_PSM[c(1:54),]
pcoa.groups <- paste(otu_design_PSM$Water_TRT, otu_design_PSM$Microbe_TRT,sep = "_")
pcoa.points <- data.frame(pcoa_PSM$points, group = pcoa.groups)
# Calculate Centroids (mean and SE)
pcoa.L.centroids <- melt(pcoa.points, id="group", measure.vars = c("X1", "X2"))
pcoa.centroids <- acast(pcoa.L.centroids, variable ~ group, mean)
pcoa.centroids.se <- acast(pcoa.L.centroids, variable ~ group, se)
pcoa.centroids.sd <- acast(pcoa.L.centroids, variable ~ group, sd)
# Combine
pcoa.cent.dataframe <- cbind(t(pcoa.centroids), t(pcoa.centroids.se))
colnames(pcoa.cent.dataframe) <- c("V1", "V2", "V1e", "V2e")
pcoa.cent.treats <- rownames(pcoa.cent.dataframe)
Microbe <- c("No Addition", "Autoclaved Inocula", "Added Inocula","No Addition", "Autoclaved Inocula", "Added Inocula")
Water <- c("FRESH","FRESH","FRESH","SALT","SALT","SALT")
pcoa.cent.dataframe.trts <- as.data.frame(pcoa.cent.dataframe)
pcoa.cent.dataframe.trts$Microbe <- as.factor(Microbe)
pcoa.cent.dataframe.trts$Water <- as.factor(Water)
view(pcoa.cent.dataframe.trts)
df1a <- pcoa.cent.dataframe.trts
#Plot
plot1a <- ggplot(df1a, aes(x=V1, y=V2, colour=Water, shape = Microbe)) + theme_bw()
bact_PSM_avg <- plot1a + theme(panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
axis.line = element_line(colour = "black")) +
theme(panel.background = element_blank()) +
geom_errorbarh(aes(xmax=V1+V1e, xmin=V1-V1e, height=0.01), colour="black") +
geom_errorbar(aes(ymax=V2+V2e, ymin=V2-V2e, width=0.01), colour="black") +
geom_point(aes(colour=Water), size=5, stroke = 1.25, show.legend = TRUE) +
scale_color_manual(name="Treatment",
values=c("#004AAD", "#FFBD59")) +
theme(axis.title = element_text(size=14),
axis.text = element_text(size=14),
axis.text.x = element_text(size=14),
panel.border = element_rect(colour = "black", linewidth = 1.25)) +
theme(axis.ticks.length = unit(0.3, "cm")) +
xlab("PCoA 1 (21.9%)") + ylab("PCoA 2 (11.7%)") +
labs(colour = "Water", shape = "Microbe") +
guides(colour = guide_legend(override.aes = list(pch=16, size = 4)),
shape = guide_legend(override.aes = list(size = 4))) +
ggtitle("Bacterial 16SrRNA Community Composition (centroid)")
bact_PSM_avg
ggsave("../figures/PSM.bact.ordination.jpg", plot=last_plot(), device=NULL, path=NULL, scale=1, width=7, height=5, dpi=300, limitsize=TRUE)
#PSM_BC <- vegdist(otu_design_PSM[c(1:54),-c(1:15)], method="bray") #deleted last three samples which are baseline soils
##pcoa_PSM <- cmdscale(PSM_BC, k=2, eig=TRUE, add=TRUE) # changing k to 2 because we only want 2 dimensions anyway
# Now trying add = TRUE because of https://www.youtube.com/watch?v=G5Qckqq5Erw
#explainvar1b_PSM <- round(pcoa_PSM$eig[1] / sum(pcoa_PSM$eig), 3) * 100
#explainvar2b_PSM <- round(pcoa_PSM$eig[2] / sum(pcoa_PSM$eig), 3) * 100
#sum.eigb <- sum(explainvar1b_PSM, explainvar2b_PSM)
#explainvar1b_PSM # 21.9
#explainvar2b_PSM # 11.7
pcoa_PSM.groups <- paste(otu_design_PSM$Water_TRT, otu_design_PSM$Microbe_TRT, sep = "_")
pcoa_PSM.points <- data.frame(pcoa_PSM$points, group = pcoa_PSM.groups)
pcoa.PSM.cent.dataframe.trts <- as.data.frame(pcoa_PSM.points)
#"No Addition", "Autoclaved Inocula", "Added Inocula"
Microbe <- c("Added Inocula","Added Inocula","Added Inocula","Added Inocula","Added Inocula","Added Inocula","Added Inocula","Added Inocula","Added Inocula","Added Inocula","Added Inocula","Added Inocula","Added Inocula","Added Inocula","Added Inocula","Added Inocula","Added Inocula","Added Inocula", "Autoclaved Inocula","Autoclaved Inocula","Autoclaved Inocula","Autoclaved Inocula","Autoclaved Inocula","Autoclaved Inocula","Autoclaved Inocula","Autoclaved Inocula","Autoclaved Inocula","Autoclaved Inocula","Autoclaved Inocula","Autoclaved Inocula","Autoclaved Inocula","Autoclaved Inocula","Autoclaved Inocula","Autoclaved Inocula","Autoclaved Inocula","No Addition","No Addition","No Addition","No Addition","No Addition","No Addition","No Addition","No Addition","No Addition","No Addition","No Addition","No Addition","No Addition","No Addition","No Addition","No Addition","No Addition","No Addition","No Addition")
Water <- c("FRESH","FRESH","FRESH","FRESH","FRESH","FRESH","FRESH","FRESH","FRESH","SALT","SALT","SALT","SALT","SALT","SALT","SALT","SALT","SALT","FRESH","FRESH","FRESH","FRESH","FRESH","FRESH","FRESH","FRESH","FRESH","SALT","SALT","SALT","SALT","SALT","SALT","SALT","SALT","FRESH","FRESH","FRESH","FRESH","FRESH","FRESH","FRESH","FRESH","FRESH","FRESH","SALT","SALT","SALT","SALT","SALT","SALT","SALT","SALT","SALT")
pcoa_PSM_indiv <- cbind(pcoa.PSM.cent.dataframe.trts,Water, Microbe)
str(pcoa_PSM_indiv)
pcoa_PSM_indiv$Water <- as.factor(pcoa_PSM_indiv$Water)
pcoa_PSM_indiv$Microbe <- as.factor(pcoa_PSM_indiv$Microbe)
dim(pcoa_PSM_indiv)
df1a <- pcoa_PSM_indiv
str(df1a)
#Plot using ggplot2 - individual
bact_PSM_indiv<- ggplot(df1a, aes(x=X1, y=X2, shape=Microbe, colour=Water)) +
geom_point(aes(shape = Microbe, colour = Water), stroke = 4) +
#removes gridlines from plot
theme_bw() +
theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
axis.line = element_line(colour = "black")) +
theme(axis.title = element_text(size=14),# face="bold"),
axis.text.x = element_text(size=14, color="black"),  axis.text.y = element_text(size=14, color="black"),
panel.border = element_rect(colour = "black", linewidth=1.25)) +
scale_color_manual(name="Treatment",
values=c("#004AAD", "#FFBD59")) +
#Set plot title text size
theme(plot.title=element_text(size=14)) +
#Set legend text size
theme(legend.text=element_text(size=10, face="bold"), legend.title = element_text(size=10, face="bold"))+
#Sets size of tick marks on axis
theme(axis.ticks.length=unit(0.3,"cm")) +
#Sets labels for plot title, axis titles, and legend headings
xlab("PCoA 1 (21.9%)") + ylab("PCoA 2 (11.7%)") +
labs(shape = "Microbe") +
labs(colour="Water") +
guides(color = guide_legend(override.aes = list(size = 1))) +
ggtitle("Bacterial 16SrRNA Community Composition (individual)")
bact_PSM_indiv
ggsave("../figures/PSM.bact.indiv.ordination.jpg", plot=last_plot(), device=NULL, path=NULL, scale=1, width=7, height=5, dpi=300, limitsize=TRUE)
library(ggplot2)
library(patchwork)
# change labels
p1 <- shannon_PSM
p2 <- evenness_PSM
p3 <- bact_PSM_avg
p4 <- bact_PSM_indiv
# Hide legends for plots you don’t want
p1 <- p1 + theme(legend.position = "none")
p2 <- p2 + theme(legend.position = "none")
p3 <- p3 + theme(legend.position = "bottom")
p4 <- p4 + theme(legend.position = "none")
# Combine 2x2 layout
combined <- (p1 | p2) / (p3 | p4) +
plot_annotation(tag_levels = "A")  # optional subplot labels
ggsave("../figures/combined_bacteria.png", plot=last_plot(), device=NULL, path=NULL, scale=1, width=12, height=12, dpi=900, limitsize=TRUE)
